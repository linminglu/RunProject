//
//  PGCProjectInfoController.m
//  跑工程
//
//  Created by Mac on 16/10/13.
//  Copyright © 2016年 Mac. All rights reserved.
//

#import "PGCProjectInfoController.h"
#import "PGCProjectInfoNavigationBar.h"
#import "PGCProjectInfoCell.h"
#import "PGCMapViewController.h"
#import "PGCRecordViewController.h"
#import "PGCCollectViewController.h"
#import "PGCProjectInfoDetailViewController.h"

#import "PGCDropdownButton.h"
#import "PGCDropdownAreaTable.h"
#import "PGCDropdownTypeTable.h"
#import "PGCDropdownStageTable.h"

@interface PGCProjectInfoController () <UITableViewDataSource, UITableViewDelegate, PGCProjectInfoNavigationBarDelegate, PGCDropdownButtonDelegate>


@property (strong, nonatomic) UITableView *tableView;
// 表格视图的背景视图
@property (strong, nonatomic) UIView *backgroundView;
// 地区按钮点击后的下拉菜单
@property (strong, nonatomic) PGCDropdownAreaTable *dropdownAreaTable;
// 类别按钮点击后的下拉菜单
@property (strong, nonatomic) PGCDropdownTypeTable *dropdownTypeTable;
// 阶段按钮点击后的下拉菜单
@property (strong, nonatomic) PGCDropdownStageTable *dropdownStageTable;


- (void)initializeDataSource; /** 初始化数据 */
- (void)initializeUserInterface; /** 初始化用户界面 */

@end

@implementation PGCProjectInfoController

- (void)viewWillAppear:(BOOL)animated {
    [super viewWillAppear:animated];
    
    self.navigationController.navigationBar.hidden = true;
}

- (void)viewWillDisappear:(BOOL)animated {
    [super viewWillDisappear:animated];
    
    self.navigationController.navigationBar.hidden = false;
}

- (void)viewDidLoad {
    [super viewDidLoad];
    
    [self initializeDataSource];
    [self initializeUserInterface];
}


#pragma mark - Initialize

- (void)initializeUserInterface {
    self.view.backgroundColor = [UIColor whiteColor];
    self.automaticallyAdjustsScrollViewInsets = false;
    
    // 自定义导航栏
    PGCProjectInfoNavigationBar *navigationBar = [[PGCProjectInfoNavigationBar alloc] initWithFrame:CGRectZero];
    navigationBar.delegate = self;
    [self.view addSubview:navigationBar];
    // 开始自动布局
    navigationBar.sd_layout
    .topSpaceToView(self.view, 0)
    .leftSpaceToView(self.view, 0)
    .rightSpaceToView(self.view, 0)
    .heightIs(STATUS_AND_NAVIGATION_HEIGHT);
    
    // 下拉菜单的按钮
    PGCDropdownButton *dropdownButton = [[PGCDropdownButton alloc] initWithFrame:CGRectZero titles:@[@"地区", @"类别", @"阶段"]];
    dropdownButton.delegate = self;
    [self.view addSubview:dropdownButton];
    // 开始自动布局
    dropdownButton.sd_layout
    .topSpaceToView(navigationBar, 0)
    .leftSpaceToView(self.view, 0)
    .rightSpaceToView(self.view, 0)
    .heightIs(40);
    
    // 表格视图
    UITableView *tableView = [[UITableView alloc] initWithFrame:CGRectZero style:UITableViewStylePlain];
    tableView.delegate = self;
    tableView.dataSource = self;
    [tableView registerClass:[PGCProjectInfoCell class] forCellReuseIdentifier:kPGCProjectInfoCell];
    [self.view addSubview:tableView];
    self.tableView = tableView;
    // 开始自动布局
    tableView.sd_layout
    .topSpaceToView(dropdownButton, 0)
    .leftSpaceToView(self.view, 0)
    .rightSpaceToView(self.view, 0)
    .bottomSpaceToView(self.view, TAB_BAR_HEIGHT);
    
    // 下拉菜单的背景视图
    _backgroundView = [[UIView alloc] initWithFrame:tableView.frame];
    _backgroundView.backgroundColor = [UIColor blackColor];
    _backgroundView.alpha = 0.6;

    // 地区的下拉菜单
    PGCDropdownAreaTable *dropdownAreaTable = [[PGCDropdownAreaTable alloc] initWithFrame:CGRectZero];
    [PGCKeyWindow addSubview:dropdownAreaTable];
    self.dropdownAreaTable = dropdownAreaTable;
    // 开始自动布局
    dropdownAreaTable.sd_layout
    .topSpaceToView(dropdownButton, 0)
    .leftSpaceToView(self.view, 0)
    .rightSpaceToView(self.view, 0)
    .heightRatioToView(self.view, 0);
    
    // 类别的下拉菜单
    PGCDropdownTypeTable *dropdownTypeTable = [[PGCDropdownTypeTable alloc] initWithFrame:CGRectZero];
    [PGCKeyWindow addSubview:dropdownTypeTable];
    self.dropdownTypeTable = dropdownTypeTable;
    // 开始自动布局
    dropdownTypeTable.sd_layout
    .topSpaceToView(dropdownButton, 0)
    .leftSpaceToView(self.view, 0)
    .rightSpaceToView(self.view, 0)
    .heightRatioToView(self.view, 0);
    
    // 类别的下拉菜单
    PGCDropdownStageTable *dropdownStageTable = [[PGCDropdownStageTable alloc] initWithFrame:CGRectZero];
    [PGCKeyWindow addSubview:dropdownStageTable];
    self.dropdownStageTable = dropdownStageTable;
    // 开始自动布局
    dropdownStageTable.sd_layout
    .topSpaceToView(dropdownButton, 0)
    .leftSpaceToView(self.view, 0)
    .rightSpaceToView(self.view, 0)
    .heightRatioToView(self.view, 0);
}



#pragma mark - PGCProjectInfoNavigationBarDelegate

- (void)projectInfoNavigationBar:(PGCProjectInfoNavigationBar *)PGCProjectInfoNavigationBar tapItem:(NSInteger)tag {
    switch (tag) {
        case mapItemTag:
        {
            [self.navigationController pushViewController:[PGCMapViewController new] animated:true];
        }
            break;
        case recordItemTag:
        {
            [self.navigationController pushViewController:[PGCRecordViewController new] animated:true];
        }
            break;
        case collectItemTag:
        {
            [self.navigationController pushViewController:[PGCCollectViewController new] animated:true];
        }
            break;
        case searchItemTag:
        {
            PGCLog(@"搜索");
        }
            break;
        default:
            break;
    }
}



#pragma mark - PGCDropdownButtonDelegate

- (void)dropdownButton:(PGCDropdownButton *)dropdownButton showButton:(UIButton *)button {
    
    [UIView animateWithDuration:0.25 animations:^{
        [PGCKeyWindow addSubview:_backgroundView];
        
        if (button.tag == 10000) {
            
            [self.view bringSubviewToFront:self.dropdownAreaTable];
            
            self.dropdownAreaTable.sd_layout
            .heightRatioToView(self.view, 0.5);
            
            [self.dropdownAreaTable updateLayout];
        }
        else if (button.tag == 10001) {
            
            [self.view bringSubviewToFront:self.dropdownTypeTable];
            
            self.dropdownTypeTable.sd_layout
            .heightRatioToView(self.view, 0.5);
            
            [self.dropdownTypeTable updateLayout];
        }
        else {
            
            [self.view bringSubviewToFront:self.dropdownStageTable];
            
            self.dropdownStageTable.sd_layout
            .heightRatioToView(self.view, 0.5);
            
            [self.dropdownStageTable updateLayout];
        }
    } completion:^(BOOL finished) {
        
    }];
}

- (void)dropdownButton:(PGCDropdownButton *)dropdownButton hideButton:(UIButton *)button {
    [UIView animateWithDuration:0.25 animations:^{
        if (button.tag == 10000) {
            self.dropdownAreaTable.sd_layout
            .heightIs(0);
  
            [self.dropdownAreaTable updateLayout];
        }
        else if (button.tag == 10001) {

            self.dropdownTypeTable.sd_layout
            .heightIs(0);
            
            [self.dropdownTypeTable updateLayout];
        }
        else {
            
            self.dropdownStageTable.sd_layout
            .heightIs(0);
            
            [self.dropdownStageTable updateLayout];
        }
    } completion:^(BOOL finished) {
        [self.backgroundView removeFromSuperview];
    }];
}



#pragma mark - UITableViewDataSource

- (NSInteger) tableView:(UITableView *)tableView numberOfRowsInSection:(NSInteger)section {
    return 8;
}

- (UITableViewCell *)tableView:(UITableView *)tableView cellForRowAtIndexPath:(NSIndexPath *)indexPath {
    PGCProjectInfoCell *cell = [tableView dequeueReusableCellWithIdentifier:kPGCProjectInfoCell forIndexPath:indexPath];
    
    // 点击cell不变色
    cell.selectionStyle = UITableViewCellSelectionStyleNone;
    return cell;
}


#pragma mark - UITableViewDelegate

- (CGFloat) tableView:(UITableView *)tableView heightForRowAtIndexPath:(NSIndexPath *)indexPath {
    return 120;
}

- (void)tableView:(UITableView *)tableView didSelectRowAtIndexPath:(NSIndexPath *)indexPath {
    [self.navigationController pushViewController:[PGCProjectInfoDetailViewController new] animated:true];
}



- (void)initializeDataSource {
//    _titleArray = @[@"地区", @"类别", @"阶段"];
//    _leftArray = @[@[@"附近", @"熱門商區", @"香洲區", @"斗門區", @"金灣區"], @[]];
//    _rightArray = @[ @[
//                         @[@{@"title":@"500米"}, @{@"title":@"1000米"}, @{@"title":@"2000米"}, @{@"title":@"5000米"}],
//                         @[@{@"title":@"全部商區"}, @{@"title":@"拱北"}, @{@"title":@"香洲"}, @{@"title":@"吉大"}, @{@"title":@"華髮商都"}, @{@"title":@"富華里"}, @{@"title":@"揚名廣場"}, @{@"title":@"摩爾廣場"}, @{@"title":@"井岸鎮"}, @{@"title":@"紅旗鎮"}, @{@"title":@"三灶鎮"}],
//                         @[ @{@"title":@"全部香洲區"}, @{@"title":@"拱北"}, @{@"title":@"香洲"}, @{@"title":@"吉大"}, @{@"title":@"華髮商都"}, @{@"title":@"富華里"}, @{@"title":@"揚名廣場"}, @{@"title":@"摩爾廣場"}],
//                         @[ @{@"title":@"全部斗門區"}, @{@"title":@"井岸鎮"}],
//                         @[@{@"title":@"全部金灣區"}, @{@"title":@"紅旗鎮"}, @{@"title":@"三灶鎮"}]],
//                     @[@[@{@"title":@"one"}, @{@"title":@"two"}, @{@"title":@"three"}],
//                       @[@{@"title":@"four"}]]];
}


@end
